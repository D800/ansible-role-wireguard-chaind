#jinja2: lstrip_blocks:"True",trim_blocks:"True"
{# Copyright (C) 2018-2024 Robert Wimmer
 # SPDX-License-Identifier: GPL-3.0-or-later
 #}
# {{ ansible_managed }}

[Interface]
# {{ inventory_hostname }} - {{ wireguard_interface | default('wg0') }}
{% if wireguard_address is defined %}
Address = {{ wireguard_address }}
{% endif %}
{% if wireguard_addresses is defined %}
{%  for wg_addr in wireguard_addresses %}
Address = {{ wg_addr }}
{%  endfor %}
{% endif %}
PrivateKey = {{ wireguard_private_key }}
{% if wireguard_endpoint is defined and wireguard_endpoint != "" %}
ListenPort = {{ wireguard_port | default(51820) }}
{% endif %}
{% if wireguard_dns is defined %}
DNS = {{ wireguard_dns }}
{% endif %}
{% if wireguard_fwmark is defined %}
FwMark = {{ wireguard_fwmark }}
{% endif %}
{% if wireguard_mtu is defined %}
MTU = {{ wireguard_mtu }}
{% endif %}
{% if wireguard_table is defined %}
Table = {{ wireguard_table }}
{% endif %}
{% if wireguard_preup is defined %}
{% for wg_preup in wireguard_preup %}
PreUp = {{ wg_preup }}
{% endfor %}
{% endif %}
{% if wireguard_postup is defined %}
{% for wg_postup in wireguard_postup %}
PostUp = {{ wg_postup }}
{% endfor %}
{% endif %}
{% if wireguard_predown is defined %}
{% for wg_predown in wireguard_predown %}
PreDown = {{ wg_predown }}
{% endfor %}
{% endif %}
{% if wireguard_postdown is defined %}
{% for wg_postdown in wireguard_postdown %}
PostDown = {{ wg_postdown }}
{% endfor %}
{% endif %}
{% if wireguard_save_config is defined %}
SaveConfig = {{ wireguard_save_config }}
{% endif %}

{% macro get_allowed_ips_for_higher_indexes(peer_index) %}
{%   set higher_hosts = ansible_play_hosts | selectattr('wireguard_chain_index', 'defined') | selectattr('wireguard_chain_index', 'gt', peer_index) | list %}
{%   for h in higher_hosts %}{{ hostvars[h].wireguard_allowed_ips }},{% endfor %}
{% endmacro %}

{% macro get_allowed_ips_for_lower_indexes(peer_index) %}
{%   set lower_hosts = ansible_play_hosts | selectattr('wireguard_chain_index', 'defined') | selectattr('wireguard_chain_index', 'lt', peer_index) | list %}
{%   for h in lower_hosts %}{{ hostvars[h].wireguard_allowed_ips }},{% endfor %}
{% endmacro %}

{% for host in ansible_play_hosts %}
{%   if host != inventory_hostname and hostvars[host].wireguard_chain_index is defined and wireguard_chain_index is defined %}
{%     set current_index = wireguard_chain_index | int %}
{%     set peer_index = hostvars[host].wireguard_chain_index | int %}
{%     if peer_index == current_index + 1 or peer_index == current_index - 1 %}
[Peer]
# Name = {{ host }}
PublicKey = {{ hostvars[host].wireguard__fact_public_key }}
{%       if peer_index == current_index + 1 %}
AllowedIPs = {{ hostvars[host].wireguard_allowed_ips }}, {{ get_allowed_ips_for_higher_indexes(peer_index) }}
{%       elif peer_index == current_index - 1 %}
AllowedIPs = {{ hostvars[host].wireguard_allowed_ips }}, {{ get_allowed_ips_for_lower_indexes(peer_index) }}
{%       endif %}
{%       if hostvars[host].wireguard_endpoint is defined and hostvars[host].wireguard_endpoint != "" %}
Endpoint = {{ hostvars[host].wireguard_endpoint }}:{{ hostvars[host].wireguard_port | default(wireguard_port | default(51820)) }}
{%       endif %}
{%       if hostvars[host].wireguard_persistent_keepalive is defined %}
PersistentKeepalive = {{ hostvars[host].wireguard_persistent_keepalive }}
{%       endif %}
{%     endif %}
{%   endif %}
{% endfor %}

{% if wireguard_unmanaged_peers is defined %}
{%   for peer in wireguard_unmanaged_peers %}
[Peer]
# Name = {{ peer.name | default('unmanaged_peer') }}
PublicKey = {{ peer.public_key }}
AllowedIPs = {{ peer.allowed_ips }}
{%     if peer.endpoint is defined %}
Endpoint = {{ peer.endpoint }}
{%     endif %}
{%     if peer.persistent_keepalive is defined %}
PersistentKeepalive = {{ peer.persistent_keepalive }}
{%     endif %}
{%   endfor %}
{% endif %}